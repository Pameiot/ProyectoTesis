<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>SISTEMA IOT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="shortcut icon" href="/recursos/utn.png" type="image/x-icon">
    <link rel="stylesheet" href="/css/estilo.css" />
</head>

<body>
    <div class="container my-4">
        <div class="d-flex align-items-center justify-content-between" style="gap:20px; flex-wrap:nowrap">
            <img src="/recursos/utn.png" class="img-fluid" style="height:80px" />
            <h2 class="text-center fw-bold m-0 flex-grow-1" style="font-size:16px">
                SISTEMA IOT DE MONITOREO DE RESIDUOS ORGÁNICOS DE GANADO BOVINO
            </h2>
            <img src="/recursos/Fica.png" class="img-fluid" style="height:40px" />
        </div>
    </div>

    <div class="botones text-center my-3">
        <a href="/" class="btn btn-dark mx-2">DATOS</a>
        <a href="/grafica" class="btn btn-dark mx-2">GRAFICA</a>
        <a href="/knn" class="btn btn-dark mx-2">RESULTADOS</a>
        <a href="/entrenamiento" class="btn btn-dark mx-2">ENTRENAMIENTO</a>
    </div>

    <!-- FILTRO -->
    <div class="container mb-4">
        <div class="d-flex flex-wrap justify-content-center align-items-end gap-3">
            <div class="btn-group">
                <button class="btn btn-outline-primary" id="btnHoy">Hoy</button>
                <button class="btn btn-outline-primary" id="btn7">7 días</button>
                <button class="btn btn-outline-primary" id="btn30">30 días</button>
            </div>

            <div>
                <label class="form-label mb-0">Desde</label>
                <input type="date" class="form-control" id="fechaInicio">
            </div>

            <div>
                <label class="form-label mb-0">Hasta</label>
                <input type="date" class="form-control" id="fechaFin">
            </div>

            <div>
                <button class="btn btn-success mt-4" id="btnAplicar">Aplicar filtro</button>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-2">
            <div id="rangoActivo" class="text-muted small"></div>
        </div>
    </div>

    <!-- GRAFICAS -->
    <div class="container">
        <div class="row g-4">
            <div class="col-md-4"><canvas id="graficaAmbiental"></canvas></div>
            <div class="col-md-4"><canvas id="graficaTemperatura"></canvas></div>
            <div class="col-md-4"><canvas id="graficaHumedad"></canvas></div>
            <div class="col-md-4"><canvas id="graficaPH"></canvas></div>
            <div class="col-md-4"><canvas id="graficaGas"></canvas></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let labels = [], temperaturas = [], humedades = [], phs = [], gases = [], t_amb = [], h_amb = [];
        let rangoDesdeActual = null;
        let rangoHastaActual = null;
        let charts = {};

        function crearGrafica(id, datasets, titulo, minY = 0, maxY = 100) {
            const ctx = document.getElementById(id).getContext("2d");
            if (charts[id]) charts[id].destroy();

            charts[id] = new Chart(ctx, {
                type: "line",
                data: { labels, datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { usePointStyle: true } },
                        title: { display: true, text: titulo, font: { size: 12 } }
                    },
                    scales: {
                        x: { ticks: { display: false }, title: { display: true, text: "Fecha y Hora" } },
                        y: { beginAtZero: true, min: minY, max: maxY, title: { display: true, text: "Valor" } }
                    }
                }
            });
        }

        function actualizarGraficas() {
            crearGrafica("graficaAmbiental", [
                { label:"T. Ambiente", data:t_amb, borderColor:"purple", backgroundColor:"rgba(128,0,128,0.2)", fill:true },
                { label:"H. Ambiente", data:h_amb, borderColor:"teal", backgroundColor:"rgba(0,128,128,0.2)", fill:true }
            ], "Temperatura y Humedad Ambiental");

            crearGrafica("graficaTemperatura", [
                { label:"Temperatura", data:temperaturas, borderColor:"red", backgroundColor:"rgba(255,0,0,0.2)", fill:true }
            ], "Temperatura de la Fosa", 0, 60);

            crearGrafica("graficaHumedad", [
                { label:"Humedad", data:humedades, borderColor:"blue", backgroundColor:"rgba(0,0,255,0.2)", fill:true }
            ], "Humedad del Suelo", 0, 100);

            crearGrafica("graficaPH", [
                { label:"pH", data:phs, borderColor:"green", backgroundColor:"rgba(0,128,0,0.2)", fill:true }
            ], "pH", 0, 14);

            crearGrafica("graficaGas", [
                { label:"Gas", data:gases, borderColor:"orange", backgroundColor:"rgba(255,165,0,0.2)", fill:true }
            ], "Gas", 0, 200);
        }

        function fmt(d){ return d.toISOString().slice(0,10); }

        async function cargarRango(desde, hasta){
            rangoDesdeActual = desde;
            rangoHastaActual = hasta;

            const res = await fetch(`/historial?desde=${desde}&hasta=${hasta}`);
            const data = await res.json();

            labels = data.labels || [];
            temperaturas = data.temperaturas || [];
            humedades = data.humedades || [];
            gases = data.gases || [];
            phs = data.phs || [];
            t_amb = data.t_amb || [];
            h_amb = data.h_amb || [];

            document.getElementById("rangoActivo").textContent =
                `Mostrando: ${desde} → ${hasta}`;

            actualizarGraficas();
        }

        btnHoy.onclick = () => {
            const h = new Date();
            cargarRango(fmt(h), fmt(h));
            fechaInicio.value = fmt(h);
            fechaFin.value = fmt(h);
        };

        btn7.onclick = () => {
            const h = new Date();
            const d = new Date(); d.setDate(h.getDate()-6);
            cargarRango(fmt(d), fmt(h));
            fechaInicio.value = fmt(d);
            fechaFin.value = fmt(h);
        };

        btn30.onclick = () => {
            const h = new Date();
            const d = new Date(); d.setDate(h.getDate()-29);
            cargarRango(fmt(d), fmt(h));
            fechaInicio.value = fmt(d);
            fechaFin.value = fmt(h);
        };

        btnAplicar.onclick = () => {
            if (!fechaInicio.value || !fechaFin.value) return alert("Selecciona fechas");
            if (fechaInicio.value > fechaFin.value) return alert("Rango inválido");
            cargarRango(fechaInicio.value, fechaFin.value);
        };

        window.addEventListener("DOMContentLoaded", () => btnHoy.click());

        setInterval(() => {
            if (rangoDesdeActual && rangoHastaActual) {
                cargarRango(rangoDesdeActual, rangoHastaActual);
            }
        }, 30000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

